pipeline {
    agent any

    tools {
        maven 'M3'
        jdk 'JDK17'
    }

    environment {
        // Configuration des credentials
        DOCKERHUB_CREDENTIALS = credentials('docker-hub-credentials')
        SONAR_SCANNER_HOME = tool 'SonarScanner'
        NEXUS_URL = 'http://nexus-server:8081'
        
        // Variables pour les images et artefacts
        DOCKER_IMAGE = "mohamedsaadaoui/adoption-animaux:${env.BUILD_ID}"
        ARTIFACT_NAME = "adoption-Project-0.0.1-SNAPSHOT.jar"
    }

    stages {
        // 1. R√âCUP√âRATION DU PROJET DE GIT
        stage('R√©cup√©ration Git') {
            steps {
                echo "üì¶ √âtape 1: R√©cup√©ration du code depuis Git"
                git branch: 'master', 
                    url: 'https://github.com/mohamedsaadaoui/adoption-animaux.git'
            }
        }

        // 2. COMPILATION DU PROJET
        stage('Compilation') {
            steps {
                echo "üî® √âtape 2: Compilation du projet Maven"
                sh 'mvn clean compile'
            }
        }

        // 3. LANCEMENT DES TESTS UNITAIRES JUNIT
        stage('Tests Unitaires JUnit') {
            steps {
                echo "üß™ √âtape 3: Ex√©cution des tests unitaires"
                sh 'mvn test -DskipTests=false'
            }
            post {
                always {
                    // Publication des r√©sultats JUnit
                    junit 'target/surefire-reports/*.xml'
                    archiveArtifacts 'target/surefire-reports/*.xml'
                }
            }
        }

        // 4. TESTS DE QUALIT√â DE CODE SONARQUBE
        stage('Analyse Qualit√© SonarQube') {
            steps {
                echo "üìä √âtape 4: Analyse de qualit√© avec SonarQube"
                withSonarQubeEnv('sonar-server') {
                    sh """
                    mvn sonar:sonar \
                        -Dsonar.projectKey=adoption-animaux \
                        -Dsonar.projectName=Adoption-Animaux \
                        -Dsonar.host.url=\${SONAR_HOST_URL} \
                        -Dsonar.login=\${SONAR_AUTH_TOKEN}
                    """
                }
            }
        }

        // 5. PR√âPARATION DE LA VERSION √Ä DISTRIBUER
        stage('Pr√©paration Version') {
            steps {
                echo "üì¶ √âtape 5: Packaging de l'application"
                sh 'mvn clean package -DskipTests'
                
                // V√©rification du fichier JAR
                sh """
                if [ -f "target/${ARTIFACT_NAME}" ]; then
                    echo "‚úÖ JAR cr√©√© avec succ√®s: ${ARTIFACT_NAME}"
                    ls -lh target/${ARTIFACT_NAME}
                else
                    echo "‚ùå Erreur: Fichier JAR non trouv√©"
                    exit 1
                fi
                """
            }
        }

        // 6. MISE EN PLACE DANS NEXUS
        stage('D√©ploiement Nexus') {
            steps {
                echo "üè∫ √âtape 6: D√©ploiement vers Nexus"
                script {
                    // Alternative si le plugin Nexus n'est pas disponible
                    sh """
                    curl -u \${NEXUS_USER}:\${NEXUS_PASSWORD} \
                         --upload-file target/${ARTIFACT_NAME} \
                         ${NEXUS_URL}/repository/maven-releases/com/example/adoption-animaux/1.0.0/${ARTIFACT_NAME}
                    """
                }
            }
        }

        // 7. CR√âATION IMAGE DOCKER
        stage('Build Image Docker') {
            steps {
                echo "üê≥ √âtape 7: Construction de l'image Docker"
                script {
                    docker.build("${env.DOCKER_IMAGE}")
                }
            }
        }

        // 8. D√âP√îT SUR DOCKERHUB
        stage('Push DockerHub') {
            steps {
                echo "üì§ √âtape 8: Publication sur DockerHub"
                script {
                    docker.withRegistry('', 'docker-hub-credentials') {
                        docker.image("${env.DOCKER_IMAGE}").push()
                        docker.image("${env.DOCKER_IMAGE}").push('latest')
                    }
                }
            }
        }

        // 9. LANCEMENT AVEC DOCKER COMPOSE
        stage('D√©ploiement Docker Compose') {
            steps {
                echo "üöÄ √âtape 9: D√©ploiement avec Docker Compose"
                sh '''
                    echo "Arr√™t des conteneurs existants..."
                    docker compose down || true
                    
                    echo "D√©marrage des services..."
                    docker compose up -d --build
                    
                    echo "Attente du d√©marrage..."
                    sleep 60
                    
                    echo "√âtat des services:"
                    docker compose ps
                '''
            }
        }

        // 10. VALIDATION FINALE
        stage('Validation D√©ploiement') {
            steps {
                echo "‚úÖ √âtape 10: Validation du d√©ploiement"
                sh '''
                    echo "V√©rification de la sant√© de l'application..."
                    curl -f http://localhost:8089/adoption/actuator/health || exit 1
                    
                    echo "Test des endpoints API..."
                    # Test cr√©ation adoptant
                    curl -X POST http://localhost:8089/adoption/addAdoptant \
                         -H "Content-Type: application/json" \
                         -d '{"nom":"TestJenkins","adresse":"123 Test","telephone":611223344}' \
                         -w "\\nCode HTTP: %{http_code}\\n"
                         
                    echo "‚úÖ D√©ploiement valid√© avec succ√®s!"
                '''
            }
        }
    }

    post {
        always {
            echo "üßπ Nettoyage de l'environnement"
            sh 'docker compose down || true'
            cleanWs()
        }
        success {
            echo "üéâ PIPELINE R√âUSSI! Toutes les √©tapes CI/CD sont compl√®tes."
            emailext (
                subject: "SUCC√àS: Pipeline Adoption-Animaux - Build #${env.BUILD_NUMBER}",
                body: """
                ‚úÖ PIPELINE CI/CD EX√âCUT√â AVEC SUCC√àS!
                
                D√©tails:
                - Build: ${env.JOB_NAME} #${env.BUILD_NUMBER}
                - Dur√©e: ${currentBuild.durationString}
                - Commit: ${env.GIT_COMMIT}
                - Lien: ${env.BUILD_URL}
                
                √âtapes accomplies:
                ‚úì R√©cup√©ration Git
                ‚úì Compilation Maven
                ‚úì Tests unitaires JUnit
                ‚úì Analyse qualit√© SonarQube
                ‚úì Packaging application
                ‚úì D√©ploiement Nexus
                ‚úì Build image Docker
                ‚úì Push DockerHub
                ‚úì D√©ploiement Docker Compose
                ‚úì Validation finale
                
                Application disponible sur: http://localhost:8089/adoption
                """,
                to: "enseignant@esprit.tn"
            )
        }
        failure {
            echo "‚ùå Pipeline √©chou√© - V√©rifier les logs"
            emailext (
                subject: "√âCHEC: Pipeline Adoption-Animaux - Build #${env.BUILD_NUMBER}",
                body: "Le pipeline CI/CD a √©chou√©. Consulter les logs: ${env.BUILD_URL}",
                to: "enseignant@esprit.tn"
            )
        }
    }
}